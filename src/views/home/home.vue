<script setup lang="ts">
import { ref, computed } from "vue";

import TooltipTag from "@/components/TooltipTag.vue";
import { ApiPrefix } from "@/constants";
import { copyText } from "@/utils";
import { useFetch, useElementBounding } from "@vueuse/core";

import NovelAi from "../novelAi/novelAi.vue";

// instance
const headerRef = ref<HTMLElement | null>(null);
const currentTabRef = ref<InstanceType<typeof NovelAi>>();

// computed
const tipsList = computed(() => currentTabRef.value?.tipsList || []);
const stringField = computed(() => currentTabRef.value?.stringField || "");

// hooks
const { top: headRefTop } = useElementBounding(headerRef);

// input value
const loading = ref(false);
const inputValue = ref("");
const translationResult = ref("");
const qq = ref(123456789);
const website = ref([
  {
    label: "midjourney",
    value: "https://www.midjourney.com/home/",
  },
  {
    label: "DreamStudio",
    value: "https://beta.dreamstudio.ai",
  },
  {
    label: "huggingface",
    value: "https://huggingface.co/spaces/lnyan/stablediffusion-infinity",
  },
  {
    label: "DALL·E 2",
    value: "https://openai.com/dall-e-2/",
  },
]);

function copy(type: "input" | "translation") {
  switch (type) {
    case "input":
      if(inputValue.value){
        copyText(inputValue.value);
      }else {
        console.log(tipsList.value)
        let copyString = '';
        for(let i = 0 ; i < tipsList.value.length ; i ++){
          copyString += tipsList.value[i]?.promptZH || tipsList.value[i]?.options || tipsList.value[i]?.img
          copyString += i == tipsList.value.length - 1 ? "" : "，";
        }
        copyText(String(copyString));
      }
      break;
    case "translation":
      copyText(translationResult.value);
      break;
  }
}

async function translation() {
  // NOTE: 拼接keyWord
  const keyWord = currentTabRef.value?.defaultKeyWordList
    .filter((x) => x.isCustom && x.isSelected)
    .map((x) => x.promptZH)
    .join(",");
  loading.value = true;
  const { data } = await useFetch(`${ApiPrefix}/translate`).post({
    origin: keyWord ? inputValue.value + "," + keyWord : inputValue.value,
  });
  loading.value = false;
  translationResult.value =
    JSON.parse(data.value as string).data + "," + stringField.value;
}
</script>

<template>
  <div class="home-page" style="min-height: calc(100vh - 180px)">
    <div class="logo" max-h-224px pt-30px overflow-hidden>
      <img w-615px ma src="@/assets/img/logo.png" alt="logo" />
      <div class="tips" p="t-4 x-5" absolute w-full top-0px flex>
        <label class="title" text-18px font-600
          ><span>prompt</span> <span>Tool</span> <span>词图</span></label
        >
        <span class="qq-style btn" text-12px m="l-a">
          <i class="icon-ren icon" mb-3px></i>
          QQ群 {{ qq }}</span
        >
      </div>
    </div>
    <header
      ref="headerRef"
      :style="{
        'box-shadow': headRefTop === 0 ? '0px 2px 16px rgba(0, 0, 0, 0.15)' : '',
        'padding-top': headRefTop === 0 ? '1rem' : ''
      }"
      class="container-input"
      p="yb-4 x-2"
    >
      <div class="input-group" flex="~" justify-center items-stretch w="100%">
        <div
          class="lt-md:max-w-500px md:max-w-688px search-input relative"
          h-auto
          p="x-0.2rem y-0.2rem"
          flex="~ grow shrink wrap gap-2"
          border="2 #222 rounded-12px"
        >
        <el-input
            text-16px
            style="width: calc(100% - 4rem)"
            v-model="inputValue"
            :autosize="{ minRows: 1, maxRows: 3 }"
            type="textarea"
            placeholder="搜罗好词、给词配图、一键翻译，让AI画家更好的作画。"
            @keypress.enter.prevent="translation"
          />
          <el-button
            class="copy h-48px"
            type="primary"
            size="default"
            @click="copy('input')"
          >
            <div class="i-carbon-copy"></div>
          </el-button>
          <div
            v-show="tipsList.length"
            class="tooltiplist"
            flex="~ gap-2"
            p="b-16px x-15px"
          >
            <TooltipTag
              v-for="item in tipsList"
              :content="item?.promptZH || item?.options || item?.img"
              :slice="16"
            ></TooltipTag>
          </div>
        </div>
        <el-button
          p="x-40px y-20px"
          m="l-2"
          text-24px
          h-60px
          type="primary"
          @click="translation"
        >
          翻译
        </el-button>
      </div>
      <div class="translation-result" flex="~" px-4 justify-center items-start>
        <div class="lt-md:w-600px md:w-784px" p="y-15px x-2px" flex="~ gap-3">
          <template v-if="!translationResult.length && !loading">
            <p style="color:#aaa">翻译结果: A lazy cat prone on the ground of the window</p>
          </template>
          <template v-if="loading">
            <i class="icon-loading icon"></i>
            <p style="color:#aaa">正在翻译...</p>
          </template>
          <template v-else-if="translationResult.length > 0 && !loading">
            <code class="tracking-0.5px w-37rem" color-dark-400 text-20px break-words>{{
              translationResult
            }}</code>
            <el-button
              class="copy h-48px"
              type="primary"
              size="default"
              @click="copy('translation')"
            >
              <div class="i-carbon-copy"></div>
            </el-button>
          </template>
        </div>
      </div>
    </header>
    <RouterView v-slot="{ Component }">
      <component :ref="(el: any) => currentTabRef = el" :is="Component" />
    </RouterView>
  </div>
  <footer class="bg-[#333333]" mt-52px>
    <div class="footer ma lt-lg:max-w-660px lg:max-w-828px xl:max-w-1176px 2xl:max-w-1332px" flex="~ col">
      <div min-h-180px flex="~ col" justify-center p="t-18px b-8" text-white>
        <div p="y-4" text-20px>复制翻译结果后，可以去这些网站完成绘画</div>
        <div flex="~ gap-4" text-14px>
          <a
            v-for="item in website"
            :href="item.value"
            target="_black"
            >{{ item.label }}</a
          >
        </div>
      </div>
      <div></div>
    </div>
  </footer>
</template>
<style scoped>
:deep(.container-input .el-textarea__inner) {
  color: #222;
  padding-left: 15px;
  padding-right: 15px;
  line-height: 1.4;
}
</style>
